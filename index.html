<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GitHub Leaderboard</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1320;--muted:#94a3b8;--accent:#00bcd4;--accent-2:#6ee7b7}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#061226 0%,#081726 100%);color:#e6eef6;padding:28px}
    .container{max-width:1000px;margin:0 auto}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit}
    select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.035)}
    th{cursor:pointer;user-select:none;font-weight:600}
    th .sort{opacity:0.6;margin-left:8px;font-size:12px}
    tr:hover td{background:linear-gradient(90deg,rgba(255,255,255,0.012),transparent)}
    .muted{color:var(--muted)}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:10px;color:#07212a;border:none;cursor:pointer}
    .small{font-size:13px}
    @media (max-width:720px){th,td{padding:8px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Leaderboard</h1>
        <div class="muted small">Displays leaderboard data from a table file in this repository</div>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="search" type="text" placeholder="Search players or teams..." />
        <select id="perPage">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
        </select>
        <select id="sortField">
          <option value="score">Sort by score (desc)</option>
          <option value="name">Sort by name (asc)</option>
        </select>
        <button id="refresh" class="btn">Refresh</button>
        <div style="margin-left:auto" class="muted small">Data source: <span id="sourcePath" class="pill">(configure)</span></div>
      </div>

      <div id="tableWrap">
        <table id="leaderboard">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer small">
        <div id="summary" class="muted">Loading...</div>
        <div>
          <button id="prev" class="pill">Prev</button>
          <span id="pageInfo" class="muted" style="margin:0 8px">1</span>
          <button id="next" class="pill">Next</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;color:var(--muted);font-size:13px">
      <div>How to use:</div>
      <ol>
        <li>Place this <code>index.html</code> in your repository (or GitHub Pages branch).</li>
        <li>Configure the data source below (owner, repo, branch, path) or provide a raw URL with ?rawUrl=.</li>
        <li>Leaderboard supports <code>.csv</code> or <code>.json</code> (array of objects with consistent keys).</li>
      </ol>
    </div>
  </div>

  <script>
    // -------------------------- CONFIG --------------------------
    // Edit these defaults directly in the file or use ?owner=...&repo=... in the URL
    const CONFIG = {
      owner: '',         // e.g. 'your-github-username'
      repo: '',          // e.g. 'your-repo'
      branch: 'main',    // e.g. 'main' or 'gh-pages'
      filePath: 'leaderboard.csv', // relative path in the repo
      // If you prefer, pass ?rawUrl=https://raw.githubusercontent.com/owner/repo/branch/path
    };
    // ------------------------ END CONFIG ------------------------

    // Utilities
    function $(id){return document.getElementById(id)}

    function buildRawUrlFromConfig(){
      if (getQueryParam('rawUrl')) return getQueryParam('rawUrl');
      const owner = getQueryParam('owner') || CONFIG.owner;
      const repo = getQueryParam('repo') || CONFIG.repo;
      const branch = getQueryParam('branch') || CONFIG.branch;
      const filePath = getQueryParam('filePath') || CONFIG.filePath;
      if (!owner || !repo || !filePath) return null;
      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
    }

    function getQueryParam(name){
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    function parseCSV(text){
      // Simple CSV parser (handles quoted fields). Returns array of objects using header row.
      const rows = [];
      let i=0; let cur=''; let row=[]; let inQuotes=false; let col=[];
      while(i<text.length){
        const ch=text[i];
        if(inQuotes){
          if(ch==='"' && text[i+1]==='"'){ cur+='"'; i+=2; continue }
          if(ch==='"'){ inQuotes=false; i++; continue }
          cur+=ch; i++; continue
        }
        if(ch==='"'){ inQuotes=true; i++; continue }
        if(ch===','){ row.push(cur); cur=''; i++; continue }
        if(ch==='\r'){ i++; continue }
        if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue }
        cur+=ch; i++;
      }
      if(cur!==''||row.length){ row.push(cur); rows.push(row) }
      if(rows.length===0) return [];
      const header = rows[0].map(h=>h.trim());
      const result = [];
      for(let r=1;r<rows.length;r++){
        if(rows[r].length===1 && rows[r][0]==='') continue;
        const obj = {};
        for(let c=0;c<header.length;c++) obj[header[c]] = rows[r][c]===undefined? '': rows[r][c];
        result.push(obj);
      }
      return result;
    }

    function isNumeric(n){ return !isNaN(parseFloat(n)) && isFinite(n) }

    // State
    let data = [];
    let filtered = [];
    let currentPage = 1;

    // DOM refs
    const thead = $('thead'); const tbody = $('tbody'); const search = $('search');
    const perPage = $('perPage'); const sortField = $('sortField'); const summary = $('summary');
    const prevBtn = $('prev'); const nextBtn = $('next'); const pageInfo = $('pageInfo'); const sourcePath = $('sourcePath');

    async function fetchData(){
      const rawUrl = buildRawUrlFromConfig();
      sourcePath.textContent = rawUrl || '(configure owner/repo/filePath)';
      if(!rawUrl){ summary.textContent = 'Configure owner/repo/filePath in the file or via query string.'; return }
      try{
        const res = await fetch(rawUrl);
        if(!res.ok) throw new Error('Fetch failed: '+res.status);
        const text = await res.text();
        if(rawUrl.endsWith('.json')){
          data = JSON.parse(text);
        } else if(rawUrl.endsWith('.csv') || rawUrl.indexOf('.csv')!==-1){
          data = parseCSV(text);
        } else {
          // try JSON then CSV
          try{ data = JSON.parse(text) }catch(e){ data = parseCSV(text) }
        }
        if(!Array.isArray(data)) throw new Error('Data is not an array');
        // normalize keys: trim
        data = data.map(row=>{
          const obj={};
          Object.keys(row).forEach(k=>{ obj[k.trim()] = (row[k]===null||row[k]===undefined)? '': String(row[k]).trim() })
          return obj;
        })
        initTable();
      }catch(err){ summary.textContent = 'Error loading data: '+err.message }
    }

    function initTable(){
      currentPage = 1;
      if(data.length===0){ thead.innerHTML=''; tbody.innerHTML=''; summary.textContent='No rows found'; return }
      const columns = Object.keys(data[0]);
      // Build thead
      thead.innerHTML = '<tr>'+columns.map(col=>`<th data-col="${col}">${escapeHtml(col)} <span class="sort">↕</span></th>`).join('')+'</tr>';
      // Attach click to headers
      thead.querySelectorAll('th').forEach(th=>th.addEventListener('click',()=>{
        const col = th.getAttribute('data-col');
        // toggle sortField
        if(sortField.value === col){ sortField.value = col; } else { sortField.value = col }
        applyFiltersAndRender();
      }))
      applyFiltersAndRender();
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    function applyFiltersAndRender(){
      const q = search.value.trim().toLowerCase();
      // filter
      if(q==='') filtered = data.slice();
      else filtered = data.filter(row=> Object.values(row).some(v=> String(v).toLowerCase().includes(q)));
      // sort
      const sf = sortField.value || 'score';
      filtered.sort((a,b)=>{
        const va = a[sf] || '';
        const vb = b[sf] || '';
        // numeric if both numeric
        if(isNumeric(va) && isNumeric(vb)) return parseFloat(vb) - parseFloat(va); // desc numeric
        // if field is name, sort asc
        if(sf.toLowerCase().includes('name')) return String(va).localeCompare(String(vb));
        // fallback: desc
        return String(vb).localeCompare(String(va));
      })
      renderPage();
    }

    function renderPage(){
      const per = parseInt(perPage.value,10);
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / per));
      if(currentPage > pages) currentPage = pages;
      const start = (currentPage-1)*per;
      const pageRows = filtered.slice(start, start+per);
      // render tbody
      tbody.innerHTML = pageRows.map(r=>{
        const cols = Object.keys(r).map(k=>`<td>${escapeHtml(r[k])}</td>`).join('');
        return `<tr>${cols}</tr>`;
      }).join('') || '<tr><td colspan="100%" class="muted">No rows to show</td></tr>';
      summary.textContent = `${total} rows • showing ${start+1}-${Math.min(start+pageRows.length,total)} ` + (total?`of ${total}`:'');
      pageInfo.textContent = `${currentPage}/${pages}`;
    }

    // Event wiring
    search.addEventListener('input',()=>{ currentPage =1; applyFiltersAndRender(); });
    perPage.addEventListener('change',()=>{ currentPage =1; renderPage(); });
    sortField.addEventListener('change',()=>{ applyFiltersAndRender(); });
    document.getElementById('refresh').addEventListener('click',fetchData);
    prevBtn.addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderPage(); } });
    nextBtn.addEventListener('click',()=>{ const per = parseInt(perPage.value,10); const pages = Math.max(1, Math.ceil(filtered.length / per)); if(currentPage<pages){ currentPage++; renderPage(); } });

    // bootstrap
    (function(){
      // If user provided owner/repo via query params but left CONFIG blank, we show built URL
      const raw = buildRawUrlFromConfig();
      if(raw) sourcePath.textContent = raw;
      fetchData();
    })();
  </script>
</body>
</html>
