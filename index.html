<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Target Pack Optimization Competition Leaderboard</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1320;--muted:#94a3b8;--accent:#00bcd4;--accent-2:#6ee7b7}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#061226 0%,#081726 100%);color:#e6eef6;padding:28px}
    .container{max-width:1000px;margin:0 auto}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit}
    select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    select option {background:#0b1320; color: #e6eef6;}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.035)}
    th{cursor:pointer;user-select:none;font-weight:600; white-space: nowrap;}
    th:hover{background:rgba(255,255,255,0.05);}
    th .sort{opacity:0.6;margin-left:8px;font-size:12px}
    tr:hover td{background:linear-gradient(90deg,rgba(255,255,255,0.012),transparent)}
    .muted{color:var(--muted)}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:10px;color:#07212a;border:none;cursor:pointer}
    .small{font-size:13px}
    .error-msg{ color: #ff6b6b; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 8px; margin-top: 10px; display:none; }
    @media (max-width:720px){th,td{padding:8px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>SCM 518 Pack Optimization Leaderboard</h1>
        <div class="muted small">Displays leaderboard data</div>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="search" type="text" placeholder="Search players or teams..." />
        
        <select id="perPage">
          <option value="10000" selected>All Rows</option>
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
        </select>

        <select id="sortField">
          <option value="Average Score">Sort by Score (Desc)</option>
          <option value="Team Name">Sort by Name (Asc)</option>
          <option value="Status Code">Sort by Status (Asc)</option>
        </select>

        <button id="refresh" class="btn">Refresh</button>
      </div>

      <div id="errorDisplay" class="error-msg"></div>

      <div id="tableWrap">
        <table id="leaderboard">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
        
        <p class="muted small" style="margin-top: 20px;"> Note on status of your submission:</p>
        <ul class="muted small">
          <li>0: Valid (Success)</li>
          <li>1: Constraint Violation (Infeasible solution)</li>
          <li>2: Missing Files (Config/Alloc files not found)</li>
          <li>3: Code Crash (Python errors, dimension mismatches, corrupted zips)</li>
        </ul>
      </div>

      <div class="footer small">
        <div id="summary" class="muted">Initializing...</div>
        <div>
          <button id="prev" class="pill">Prev</button>
          <span id="pageInfo" class="muted" style="margin:0 8px">1</span>
          <button id="next" class="pill">Next</button>
        </div>
      </div>
    </div>

  <script>
    // -------------------------- CONFIG --------------------------
    // Uses relative path. Ensure final_team_scores.csv is in the same folder.
    const CONFIG = {
      file: 'final_team_scores.csv' 
    };
    // ------------------------ END CONFIG ------------------------

    // Utilities
    function $(id){return document.getElementById(id)}

    function parseCSV(text){
      const rows = [];
      let i=0; let cur=''; let row=[]; let inQuotes=false;
      while(i<text.length){
        const ch=text[i];
        if(inQuotes){
          if(ch==='"' && text[i+1]==='"'){ cur+='"'; i+=2; continue }
          if(ch==='"'){ inQuotes=false; i++; continue }
          cur+=ch; i++; continue
        }
        if(ch==='"'){ inQuotes=true; i++; continue }
        if(ch===','){ row.push(cur); cur=''; i++; continue }
        if(ch==='\r'){ i++; continue }
        if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue }
        cur+=ch; i++;
      }
      if(cur!==''||row.length){ row.push(cur); rows.push(row) }
      if(rows.length===0) return [];
      
      const header = rows[0].map(h=>h.trim());
      const result = [];
      for(let r=1;r<rows.length;r++){
        if(rows[r].length===1 && rows[r][0]==='') continue; // skip empty lines
        const obj = {};
        for(let c=0;c<header.length;c++) obj[header[c]] = rows[r][c]===undefined? '': rows[r][c];
        result.push(obj);
      }
      return result;
    }

    function isNumeric(n){ return !isNaN(parseFloat(n)) && isFinite(n) }

    // State
    let data = [];
    let filtered = [];
    let currentPage = 1;

    // DOM refs
    const thead = $('thead'); const tbody = $('tbody'); const search = $('search');
    const perPage = $('perPage'); const sortField = $('sortField'); const summary = $('summary');
    const prevBtn = $('prev'); const nextBtn = $('next'); const pageInfo = $('pageInfo');
    const errorDisplay = $('errorDisplay');

    async function fetchData(){
      summary.textContent = 'Loading data...';
      errorDisplay.style.display = 'none';
      
      try{
        // Fetch relative path
        const res = await fetch(CONFIG.file);
        
        if(!res.ok) {
          throw new Error(`Failed to load ${CONFIG.file} (Status: ${res.status} ${res.statusText}). Ensure the file exists in the same repository folder.`);
        }
        
        const text = await res.text();
        
        // Basic check to see if we got HTML back instead of CSV (common 404 page issue)
        if(text.trim().startsWith('<!doctype') || text.trim().startsWith('<html')) {
            throw new Error(`File not found (Server returned HTML instead of CSV). Check filename spelling: ${CONFIG.file}`);
        }

        data = parseCSV(text);
        
        if(!Array.isArray(data) || data.length === 0) {
            throw new Error('CSV parsed but returned no rows. Check file content.');
        }

        // Clean data keys/values
        data = data.map(row=>{
          const obj={};
          Object.keys(row).forEach(k=>{ obj[k.trim()] = (row[k]===null||row[k]===undefined)? '': String(row[k]).trim() })
          return obj;
        })
        
        initTable();
      }catch(err){ 
        console.error(err);
        summary.textContent = 'Error.';
        errorDisplay.style.display = 'block';
        errorDisplay.textContent = err.message;
      }
    }

    function initTable(){
      currentPage = 1;
      const columns = Object.keys(data[0]);
      
      // Build Headers
      thead.innerHTML = '<tr>'+columns.map(col=>
        `<th data-col="${escapeHtml(col)}">
           ${escapeHtml(col)} <span class="sort">↕</span>
         </th>`
      ).join('')+'</tr>';

      // Click to sort
      thead.querySelectorAll('th').forEach(th=>{
        th.addEventListener('click', ()=>{
          const col = th.getAttribute('data-col');
          sortField.value = col; 
          applyFiltersAndRender(col);
        })
      });

      // Default Sort: Average Score
      if(columns.includes('Average Score')) {
        sortField.value = 'Average Score';
      }
      
      applyFiltersAndRender();
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    function applyFiltersAndRender(forceSortField){
      const q = search.value.trim().toLowerCase();
      
      // Filter
      if(q==='') filtered = data.slice();
      else filtered = data.filter(row=> Object.values(row).some(v=> String(v).toLowerCase().includes(q)));
      
      // Sort
      const sf = forceSortField || sortField.value || Object.keys(data[0])[0]; 
      
      filtered.sort((a,b)=>{
        const va = a[sf];
        const vb = b[sf];
        
        // Check if sorting by Score (Desc)
        const isScore = sf.toLowerCase().includes('score');

        if(isNumeric(va) && isNumeric(vb)){
            const na = parseFloat(va);
            const nb = parseFloat(vb);
            // If score, Descending (nb - na)
            if(isScore) return nb - na; 
            // Else Ascending
            return na - nb; 
        }
        return String(va).localeCompare(String(vb));
      })

      renderPage();
    }

    function renderPage(){
      const perVal = parseInt(perPage.value,10);
      const per = perVal > 0 ? perVal : 10000;
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / per));
      
      if(currentPage > pages) currentPage = pages;
      if(currentPage < 1) currentPage = 1;

      const start = (currentPage-1)*per;
      const pageRows = filtered.slice(start, start+per);
      
      tbody.innerHTML = pageRows.map(r=>{
        const cols = Object.keys(r).map(k=>`<td>${escapeHtml(r[k])}</td>`).join('');
        return `<tr>${cols}</tr>`;
      }).join('') || '<tr><td colspan="100%" class="muted">No rows to show</td></tr>';
      
      summary.textContent = `${total} rows`;
      if(per < total) summary.textContent += ` • showing ${start+1}-${Math.min(start+pageRows.length,total)}`;
      pageInfo.textContent = `${currentPage}/${pages}`;
      
      prevBtn.disabled = currentPage <= 1;
      prevBtn.style.opacity = currentPage <= 1 ? 0.5 : 1;
      nextBtn.disabled = currentPage >= pages;
      nextBtn.style.opacity = currentPage >= pages ? 0.5 : 1;
    }

    search.addEventListener('input',()=>{ currentPage = 1; applyFiltersAndRender(); });
    perPage.addEventListener('change',()=>{ currentPage = 1; renderPage(); });
    sortField.addEventListener('change',()=>{ applyFiltersAndRender(); });
    document.getElementById('refresh').addEventListener('click', fetchData);
    prevBtn.addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderPage(); } });
    nextBtn.addEventListener('click',()=>{ 
      const per = parseInt(perPage.value,10); 
      const pages = Math.max(1, Math.ceil(filtered.length / per)); 
      if(currentPage<pages){ currentPage++; renderPage(); } 
    });

    // Start
    fetchData();
  </script>
</body>
</html>